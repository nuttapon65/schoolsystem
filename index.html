<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ลงทะเบียนผู้ปกครอง</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script> <script src="https://cdn.tailwindcss.com"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style> body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; } </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxn4THGLjeO7pVcejmAb86H8wJpCa-ftm_m_2RHkomFtS91k5Durt78b3WtvtGTxRfT/exec"; 
        const LIFF_ID = "2008830546-kUtMFdic"; // เช่น 1657xxxxxx-xxxxxxxxx
    </script>

    <div class="bg-white w-full max-w-sm rounded-2xl shadow-xl overflow-hidden">
        <div class="bg-green-500 p-6 text-center text-white">
            <i class="fab fa-line text-5xl mb-2"></i>
            <h1 class="text-xl font-bold">ลงทะเบียนรับแจ้งเตือน</h1>
            <p class="text-green-100 text-sm">ระบบติดตามรถรับส่งนักเรียน</p>
        </div>

        <div class="p-6">
            <div id="liffLoading" class="text-center py-4">
                <i class="fas fa-circle-notch fa-spin text-green-500"></i> กำลังโหลดข้อมูล LINE...
            </div>

            <div id="profileSection" class="hidden text-center mb-6">
                <img id="profileImage" src="" class="w-20 h-20 rounded-full mx-auto border-4 border-green-100 shadow-sm mb-2">
                <p class="text-gray-500 text-sm">ยินดีต้อนรับผู้ปกครอง</p>
                <h2 id="displayName" class="text-lg font-bold text-gray-800">User Name</h2>
            </div>

            <form id="registerForm" onsubmit="handleRegister(event)" class="hidden space-y-4">
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">กรอกเลขประจำตัวนักเรียน</label>
                    <input type="tel" id="studentId" required placeholder="เช่น 650123" 
                           class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-200 transition text-center text-lg tracking-widest">
                </div>
                
                <input type="hidden" id="userId"> <button type="submit" id="submitBtn" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg shadow hover:bg-green-700 transition transform active:scale-95">
                    ยืนยันการลงทะเบียน
                </button>
            </form>
        </div>
    </div>

    <script>
        // เริ่มทำงานเมื่อเปิดเว็บ
        window.onload = async function() {
            await initializeLiff();
        };

        async function initializeLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                
                if (!liff.isLoggedIn()) {
                    liff.login(); // ถ้ายังไม่ล็อกอิน ให้เด้งไปหน้าล็อกอินไลน์
                    return;
                }

                // ดึงข้อมูลโปรไฟล์
                const profile = await liff.getProfile();
                
                // แสดงข้อมูลบนหน้าเว็บ
                document.getElementById('liffLoading').classList.add('hidden');
                document.getElementById('profileSection').classList.remove('hidden');
                document.getElementById('registerForm').classList.remove('hidden');
                
                document.getElementById('profileImage').src = profile.pictureUrl || "https://cdn-icons-png.flaticon.com/512/847/847969.png";
                document.getElementById('displayName').innerText = profile.displayName;
                document.getElementById('userId').value = profile.userId; // เก็บ User ID ไว้ใน Input ลับ

            } catch (err) {
                console.error('LIFF Error:', err);
                Swal.fire('ข้อผิดพลาด', 'ไม่สามารถเชื่อมต่อกับ LINE ได้ กรุณาเปิดในแอป LINE', 'error');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            
            const btn = document.getElementById('submitBtn');
            const studentId = document.getElementById('studentId').value;
            const userId = document.getElementById('userId').value;
            const displayName = document.getElementById('displayName').innerText;

            if(!userId) return Swal.fire('Error', 'ไม่พบข้อมูลผู้ใช้ LINE', 'error');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังบันทึก...';

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'register',
                        studentId: studentId,
                        userId: userId,
                        displayName: displayName
                    })
                });
                
                const res = await response.json();

                if (res.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'ลงทะเบียนสำเร็จ!',
                        text: 'ระบบได้บันทึกข้อมูลเรียบร้อยแล้ว',
                        confirmButtonText: 'ปิดหน้าต่าง'
                    }).then(() => {
                        liff.closeWindow(); // ปิดหน้าต่าง LIFF อัตโนมัติ
                    });
                } else {
                    Swal.fire('เกิดข้อผิดพลาด', res.message, 'error');
                    btn.disabled = false;
                    btn.innerText = 'ยืนยันการลงทะเบียน';
                }

            } catch (error) {
                Swal.fire('เชื่อมต่อล้มเหลว', 'กรุณาลองใหม่อีกครั้ง', 'error');
                btn.disabled = false;
                btn.innerText = 'ยืนยันการลงทะเบียน';
            }
        }
    </script>
</body>
</html>
